# Архитектура Mini App — связь с базой данных

## Проблема с GitHub Pages

**GitHub Pages** раздаёт только статические файлы (HTML, CSS, JS). Python не выполняется, к базе данных подключиться нельзя. Поэтому изменения в админке раньше сохранялись только в `localStorage` на устройстве каждого пользователя и не были общими для всех.

## Текущая архитектура

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         GITHUB PAGES (статический хостинг)               │
│  https://p4ostopen-jpg.github.io/MiniApp/                               │
│                                                                         │
│  index.html  —  загружает товары и заказы по HTTP из API                 │
│                 (fetch к API_BASE_URL)                                  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │  fetch() — REST API
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         API СЕРВЕР (Flask)                              │
│  api.py  —  запускать отдельно: python api.py  или  на Railway/Render   │
│                                                                         │
│  Эндпоинты:                                                             │
│  • GET  /api/products          — список товаров (для всех)              │
│  • GET  /api/orders            — заказы пользователя (X-User-Id)        │
│  • POST /api/orders            — создание заказа (checkout)             │
│  • GET  /api/admin/orders      — все заказы (админ)                     │
│  • PUT  /api/admin/orders/:id/status  — смена статуса заказа            │
│  • GET  /api/admin/products    — все товары (админ)                     │
│  • POST /api/admin/products    — добавить товар                         │
│  • PUT  /api/admin/products/:id       — изменить товар                  │
│  • PUT  /api/admin/products/:id/stock — изменить остаток                │
│  • DELETE /api/admin/products/:id     — удалить товар                   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │  aiosqlite
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         БАЗА ДАННЫХ (SQLite)                            │
│  shop.db  —  products, orders, order_items, users                       │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                         TELEGRAM BOT (отдельный процесс)                 │
│  bot.py  —  получает web_app_data при checkout, уведомляет админов      │
│  admin.py — команды /admin в боте                                       │
└─────────────────────────────────────────────────────────────────────────┘
```

## Как работает обновление данных

| Действие | Кто делает | Куда идёт запрос | Результат |
|----------|------------|------------------|-----------|
| Открытие магазина | Любой пользователь | `GET /api/products` | Товары из БД |
| Оформление заказа | Пользователь | `POST /api/orders` | Заказ в БД |
| Просмотр своих заказов | Пользователь | `GET /api/orders` | Заказы из БД |
| Добавить товар | Админ | `POST /api/admin/products` | Товар в БД |
| Обновить остаток | Админ | `PUT /api/admin/products/:id/stock` | Остаток в БД |
| Подтвердить заказ | Админ | `PUT /api/admin/orders/:id/status` | Статус в БД |

Все пользователи получают одни и те же данные из базы через API.

## Деплой

### 1. API (обязательно для работы магазина)

GitHub Pages не может запускать Python. API нужно разместить отдельно.

**Варианты:**

- **Railway** (railway.app) — бесплатный tier
- **Render** (render.com) — бесплатный tier  
- **PythonAnywhere** — бесплатный tier
- **VPS** (Vultr, DigitalOcean и т.п.)

**Локальный запуск (для разработки):**
```bash
python api.py
# API: http://localhost:8000
```

### 2. Изменение URL API в Mini App

В `index.html` замени `API_BASE_URL` на URL твоего API:

```javascript
// Было (локально):
const API_BASE_URL = "http://localhost:8000";

// Стало (после деплоя):
const API_BASE_URL = "https://your-app-name.onrender.com";
```

### 3. База данных

SQLite хранится в файле `shop.db` на том же сервере, где работает API. При деплое на Railway/Render файл БД создаётся на сервере. Для долгосрочного хранения данных рассмотри PostgreSQL (есть на Render/Railway).

### 4. Бот

Бот (`bot.py`) запускается отдельно (локально или на том же VPS). Он нужен для уведомлений и команд `/admin`, но не для основного потока данных — магазин работает через API.

## Порядок запуска

1. Запустить API: `python api.py` (или деплой).
2. Убедиться, что `API_BASE_URL` в `index.html` указывает на этот API.
3. Запустить бота: `python bot.py`.
4. Открыть Mini App из Telegram.

## CORS

`api.py` настроен с `CORS(app, origins=["*"])`, поэтому запросы с GitHub Pages и других доменов разрешены.
